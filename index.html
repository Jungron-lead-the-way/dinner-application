import React, { useState, useEffect } from 'react';
import { Calendar, DollarSign, Clock, User, CheckCircle, AlertCircle, Download, Eye, EyeOff } from 'lucide-react';

const DinnerApplication = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [userName, setUserName] = useState('');
  const [applications, setApplications] = useState({});
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [showSuccessPopup, setShowSuccessPopup] = useState(false);
  const [showSummary, setShowSummary] = useState(false);
  const [nameHistory, setNameHistory] = useState([]);
  const [showNameSuggestions, setShowNameSuggestions] = useState(false);
  const [nameSuggestions, setNameSuggestions] = useState([]);
  const [showApplicantNames, setShowApplicantNames] = useState({});

  // Cambodia timezone current date
  useEffect(() => {
    const updateCambodianTime = () => {
      const now = new Date();
      // UTC+7 (Cambodia timezone)
      const cambodianTime = new Date(now.getTime() + (7 * 60 * 60 * 1000));
      setCurrentDate(cambodianTime);
    };
    
    updateCambodianTime();
    const interval = setInterval(updateCambodianTime, 60000); // Update every minute
    
    return () => clearInterval(interval);
  }, []);

  // Generate calendar
  const generateCalendar = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const calendar = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Add empty cells (Monday start)
    for (let i = 0; i < (firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1); i++) {
      calendar.push(null);
    }

    // Add dates
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      calendar.push(date);
    }

    return calendar;
  };

  // Handle date selection
  const handleDateSelect = (date) => {
    if (!date) return;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (date < today) {
      alert('Cannot select past dates.');
      return;
    }
    
    setSelectedDate(date);
  };

  // Handle name input change with suggestions
  const handleNameChange = (value) => {
    setUserName(value);
    
    if (value.length > 0) {
      const suggestions = nameHistory.filter(name => 
        name.toLowerCase().includes(value.toLowerCase())
      ).slice(0, 5);
      setNameSuggestions(suggestions);
      setShowNameSuggestions(suggestions.length > 0);
    } else {
      setShowNameSuggestions(false);
    }
  };

  // Select name suggestion
  const selectNameSuggestion = (name) => {
    setUserName(name);
    setShowNameSuggestions(false);
  };

  // Handle application confirmation
  const handleApplicationConfirm = () => {
    if (!userName.trim()) {
      alert('Please enter your name.');
      return;
    }
    
    if (!selectedDate) {
      alert('Please select a date.');
      return;
    }
    
    setShowConfirmDialog(true);
  };

  // Confirm overtime application
  const confirmOvertimeApplication = () => {
    const dateKey = selectedDate.toDateString();
    const newApplications = { ...applications };
    const trimmedName = userName.trim();
    
    if (!newApplications[dateKey]) {
      newApplications[dateKey] = [];
    }
    
    // Check for duplicate application
    const existingApplication = newApplications[dateKey].find(app => app.name === trimmedName);
    if (existingApplication) {
      alert('You have already applied for this date.');
      setShowConfirmDialog(false);
      return;
    }
    
    newApplications[dateKey].push({
      name: trimmedName,
      date: selectedDate,
      amount: 2.75
    });
    
    // Update name history
    if (!nameHistory.includes(trimmedName)) {
      setNameHistory([...nameHistory, trimmedName]);
    }
    
    setApplications(newApplications);
    setShowConfirmDialog(false);
    setShowSuccessPopup(true);
    setSelectedDate(null);
    setUserName('');
    
    // Close popup after 3 seconds
    setTimeout(() => {
      setShowSuccessPopup(false);
    }, 3000);
  };

  // Change month
  const changeMonth = (direction) => {
    const newDate = new Date(currentDate);
    newDate.setMonth(newDate.getMonth() + direction);
    setCurrentDate(newDate);
  };

  // Calculate monthly summary
  const calculateMonthlySummary = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthlyApplications = Object.entries(applications).filter(([dateKey]) => {
      const date = new Date(dateKey);
      return date.getFullYear() === year && date.getMonth() === month;
    });

    const summary = {};
    const dailyDetails = {};
    let totalAmount = 0;

    monthlyApplications.forEach(([dateKey, apps]) => {
      const date = new Date(dateKey);
      const dayKey = date.getDate();
      dailyDetails[dayKey] = apps;
      
      apps.forEach(app => {
        if (!summary[app.name]) {
          summary[app.name] = { count: 0, amount: 0 };
        }
        summary[app.name].count += 1;
        summary[app.name].amount += app.amount;
        totalAmount += app.amount;
      });
    });

    return { summary, totalAmount, dailyDetails };
  };

  // Export to Excel (CSV format)
  const exportToExcel = () => {
    const { summary, totalAmount, dailyDetails } = calculateMonthlySummary();
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    
    let csvContent = `Dinner Application Report - ${year}/${month.toString().padStart(2, '0')}\n\n`;
    
    // Summary by person
    csvContent += "Employee Name,Applications Count,Total Amount\n";
    Object.entries(summary).forEach(([name, data]) => {
      csvContent += `${name},${data.count},$${data.amount.toFixed(2)}\n`;
    });
    
    csvContent += `\nTotal Amount:,$${totalAmount.toFixed(2)}\n\n`;
    
    // Daily details
    csvContent += "Daily Details\n";
    csvContent += "Date,Employee Name,Amount\n";
    Object.entries(dailyDetails).forEach(([day, apps]) => {
      apps.forEach(app => {
        csvContent += `${year}/${month.toString().padStart(2, '0')}/${day.padStart(2, '0')},${app.name},$${app.amount.toFixed(2)}\n`;
      });
    });
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `dinner_applications_${year}_${month.toString().padStart(2, '0')}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Toggle applicant names visibility
  const toggleApplicantNames = (dateKey) => {
    setShowApplicantNames(prev => ({
      ...prev,
      [dateKey]: !prev[dateKey]
    }));
  };

  const calendar = generateCalendar();
  const { summary, totalAmount, dailyDetails } = calculateMonthlySummary();
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                     'July', 'August', 'September', 'October', 'November', 'December'];

  // Check if it's the last day of the month
  const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
  const isLastDayOfMonth = currentDate.getDate() === lastDayOfMonth;

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-5xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
          <div className="text-center mb-8">
            <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
              <Calendar className="text-blue-600" />
              Dinner Application System
            </h1>
            <p className="text-gray-600">Apply for dinner support during overtime work</p>
          </div>

          {/* Name input with suggestions */}
          <div className="mb-6 relative">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              <User className="inline w-4 h-4 mr-1" />
              Employee Name
            </label>
            <input
              type="text"
              value={userName}
              onChange={(e) => handleNameChange(e.target.value)}
              onFocus={() => {
                if (userName.length > 0 && nameSuggestions.length > 0) {
                  setShowNameSuggestions(true);
                }
              }}
              onBlur={() => {
                // Delay hiding suggestions to allow click
                setTimeout(() => setShowNameSuggestions(false), 200);
              }}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter your name"
            />
            
            {/* Name suggestions dropdown */}
            {showNameSuggestions && (
              <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg">
                {nameSuggestions.map((name, index) => (
                  <button
                    key={index}
                    onClick={() => selectNameSuggestion(name)}
                    className="w-full px-4 py-2 text-left hover:bg-blue-50 first:rounded-t-lg last:rounded-b-lg"
                  >
                    {name}
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Calendar header */}
          <div className="flex justify-between items-center mb-4">
            <button
              onClick={() => changeMonth(-1)}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
            >
              ← Previous
            </button>
            
            <h2 className="text-xl font-semibold text-gray-800">
              {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
            </h2>
            
            <button
              onClick={() => changeMonth(1)}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
            >
              Next →
            </button>
          </div>

          {/* Monthly summary section */}
          <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex justify-between items-center">
              <h3 className="text-lg font-semibold text-green-800">
                <DollarSign className="inline w-5 h-5 mr-1" />
                Monthly Summary
              </h3>
              <div className="flex gap-2">
                <button
                  onClick={() => setShowSummary(!showSummary)}
                  className="px-3 py-1 bg-green-200 text-green-800 rounded hover:bg-green-300 transition-colors"
                >
                  {showSummary ? 'Hide' : 'Show'}
                </button>
                {isLastDayOfMonth && Object.keys(summary).length > 0 && (
                  <button
                    onClick={exportToExcel}
                    className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors flex items-center gap-1"
                  >
                    <Download className="w-4 h-4" />
                    Export Excel
                  </button>
                )}
              </div>
            </div>
            
            {showSummary && (
              <div className="mt-3">
                <div className="grid gap-2">
                  {Object.entries(summary).map(([name, data]) => (
                    <div key={name} className="flex justify-between bg-white p-2 rounded">
                      <span>{name}</span>
                      <span>{data.count} applications - ${data.amount.toFixed(2)}</span>
                    </div>
                  ))}
                </div>
                <div className="mt-2 pt-2 border-t border-green-300">
                  <div className="flex justify-between font-bold text-green-800">
                    <span>Total Amount:</span>
                    <span>${totalAmount.toFixed(2)}</span>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Calendar */}
          <div className="grid grid-cols-7 gap-1 mb-6">
            {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => (
              <div key={day} className="text-center py-2 font-medium text-gray-600 bg-gray-100 rounded">
                {day}
              </div>
            ))}
            
            {calendar.map((date, index) => {
              if (!date) {
                return <div key={index} className="aspect-square"></div>;
              }
              
              const dateKey = date.toDateString();
              const hasApplication = applications[dateKey] && applications[dateKey].length > 0;
              const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
              const isToday = date.toDateString() === new Date().toDateString();
              const isPast = date < new Date().setHours(0, 0, 0, 0);
              const showNames = showApplicantNames[dateKey];
              
              return (
                <div key={index} className="relative">
                  <button
                    onClick={() => handleDateSelect(date)}
                    disabled={isPast}
                    className={`w-full aspect-square p-1 rounded-lg border transition-all ${
                      isSelected
                        ? 'bg-blue-500 text-white border-blue-500'
                        : isPast
                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                        : hasApplication
                        ? 'bg-green-100 border-green-300 hover:bg-green-200'
                        : isToday
                        ? 'bg-blue-50 border-blue-300 hover:bg-blue-100'
                        : 'bg-white border-gray-200 hover:bg-gray-50'
                    }`}
                  >
                    <div className="text-sm font-medium">{date.getDate()}</div>
                    {hasApplication && (
                      <div className="text-xs text-green-600 mt-1">
                        {applications[dateKey].length} person{applications[dateKey].length > 1 ? 's' : ''}
                      </div>
                    )}
                  </button>
                  
                  {/* Show/Hide applicant names button */}
                  {hasApplication && (
                    <button
                      onClick={() => toggleApplicantNames(dateKey)}
                      className="absolute -top-1 -right-1 w-5 h-5 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition-colors"
                    >
                      {showNames ? <EyeOff className="w-3 h-3" /> : <Eye className="w-3 h-3" />}
                    </button>
                  )}
                  
                  {/* Applicant names tooltip */}
                  {hasApplication && showNames && (
                    <div className="absolute top-full left-0 z-20 mt-1 p-2 bg-black bg-opacity-90 text-white text-xs rounded shadow-lg whitespace-nowrap">
                      {applications[dateKey].map((app, i) => (
                        <div key={i}>{app.name}</div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Application button */}
          {selectedDate && (
            <div className="text-center">
              <div className="mb-4 p-4 bg-blue-50 rounded-lg">
                <h3 className="font-medium text-gray-800 mb-2">
                  Selected Date: {monthNames[selectedDate.getMonth()]} {selectedDate.getDate()}, {selectedDate.getFullYear()}
                </h3>
                <p className="text-blue-700 font-medium flex items-center justify-center gap-2">
                  <Clock className="w-4 h-4" />
                  Will you be working until after 8 PM today?
                </p>
              </div>
              
              <button
                onClick={handleApplicationConfirm}
                className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium"
              >
                Confirm Overtime Application
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Confirmation dialog */}
      {showConfirmDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-2xl max-w-sm w-full mx-4">
            <div className="text-center">
              <AlertCircle className="w-12 h-12 text-blue-500 mx-auto mb-4" />
              <h3 className="text-lg font-semibold mb-2">Confirm Application</h3>
              <p className="text-gray-600 mb-6">
                Do you want to apply for dinner support for {userName} on {monthNames[selectedDate?.getMonth()]} {selectedDate?.getDate()}?
              </p>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowConfirmDialog(false)}
                  className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={confirmOvertimeApplication}
                  className="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                >
                  Confirm
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Success popup */}
      {showSuccessPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-2xl max-w-sm w-full mx-4">
            <div className="text-center">
              <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
              <h3 className="text-lg font-semibold mb-4 text-green-700">Application Completed!</h3>
              <p className="text-gray-700 mb-2">
                The company will support you with <span className="font-bold text-green-600">$2.75</span>.
              </p>
              <p className="text-gray-700 font-medium">
                Enjoy your dinner and keep up the good work!!
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default DinnerApplication;
